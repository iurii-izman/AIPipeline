{
  "name": "WF-3: Sentry Alert â†’ Telegram + Linear (AIPipeline)",
  "active": true,
  "nodes": [
    {
      "id": "webhook-sentry",
      "name": "Sentry Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        0,
        0
      ],
      "webhookId": "wf3-sentry",
      "parameters": {
        "path": "wf3-sentry",
        "httpMethod": "POST",
        "responseMode": "onReceived",
        "options": {}
      }
    },
    {
      "id": "normalize-sentry",
      "name": "Normalize Sentry event",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        220,
        0
      ],
      "parameters": {
        "jsCode": "const root = $json.body || $json;\nconst event = root.event || root.data?.event || root;\nconst issue = root.issue || root.data?.issue || {};\nconst title = event.title || issue.title || root.message || 'Sentry alert';\nconst level = (event.level || issue.level || root.level || 'error').toLowerCase();\nconst culprit = event.culprit || issue.culprit || '';\nconst project = root.project?.slug || root.project_slug || issue.project?.slug || 'node';\nconst url = issue.web_url || issue.permalink || event.web_url || root.url || '';\nconst fingerprint = (event.fingerprint && event.fingerprint.join(',')) || issue.shortId || issue.id || '';\nconst eventId = event.event_id || root.event_id || issue.id || root.id || '';\nconst payloadSnippet = JSON.stringify(root).slice(0, 3500);\nreturn [{ json: { title, level, culprit, project, url, fingerprint, eventId, payloadSnippet } }];"
      }
    },
    {
      "id": "dedupe-sentry",
      "name": "Deduplicate Sentry event",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        440,
        -120
      ],
      "parameters": {
        "jsCode": "const db = $getWorkflowStaticData('global');\nif (!db.seen) db.seen = {};\nconst ttlMs = 7 * 24 * 60 * 60 * 1000;\nconst now = Date.now();\nfor (const [k, ts] of Object.entries(db.seen)) {\n  if (!Number.isFinite(ts) || (now - ts) > ttlMs) delete db.seen[k];\n}\nconst basis = $json.eventId || $json.fingerprint || (($json.project || '') + ':' + ($json.level || '') + ':' + ($json.title || ''));\nconst key = String(basis).slice(0, 400);\nconst seenAt = db.seen[key];\nif (seenAt && (now - seenAt) < ttlMs) {\n  return [{ json: { ...$json, isDuplicate: true, dedupeKey: key } }];\n}\ndb.seen[key] = now;\nreturn [{ json: { ...$json, isDuplicate: false, dedupeKey: key } }];"
      }
    },
    {
      "id": "if-sentry-duplicate",
      "name": "If duplicate event",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        660,
        -120
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true
          },
          "conditions": [
            {
              "leftValue": "={{ $json.isDuplicate }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "if-openai-key",
      "name": "If OPENAI_API_KEY set",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        880,
        0
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true
          },
          "conditions": [
            {
              "leftValue": "={{ $env.OPENAI_API_KEY || '' }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "openai-classify",
      "name": "OpenAI classify severity",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1100,
        -120
      ],
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ 'Bearer ' + $env.OPENAI_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { model: ($env.OPENAI_MODEL || 'gpt-4o-mini'), temperature: 0, messages: [ { role: 'system', content: 'You classify Sentry incidents. Return only compact JSON with fields: severity (critical|non_critical), confidence (0..1), reason (string <= 140 chars).' }, { role: 'user', content: JSON.stringify({ title: $('Normalize Sentry event').first().json.title, level: $('Normalize Sentry event').first().json.level, culprit: $('Normalize Sentry event').first().json.culprit, project: $('Normalize Sentry event').first().json.project, url: $('Normalize Sentry event').first().json.url, fingerprint: $('Normalize Sentry event').first().json.fingerprint }) } ] } }}",
        "options": {}
      },
      "retryOnFail": true,
      "maxTries": 4,
      "waitBetweenTries": 2000,
      "continueOnFail": true,
      "alwaysOutputData": true
    },
    {
      "id": "if-openai-call-failed",
      "name": "If OpenAI request failed",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1320,
        -220
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true
          },
          "conditions": [
            {
              "leftValue": "={{ !!$json.error }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "parse-openai",
      "name": "Parse LLM result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1320,
        -120
      ],
      "parameters": {
        "jsCode": "const base = $('Normalize Sentry event').first().json;\nconst text = $json.choices?.[0]?.message?.content || '';\nlet obj = null;\ntry { obj = JSON.parse(text); } catch {\n  const m = text.match(/{[sS]*}/);\n  if (m) {\n    try { obj = JSON.parse(m[0]); } catch {}\n  }\n}\nconst sev = String(obj?.severity || '').toLowerCase();\nconst severity = sev === 'critical' ? 'critical' : 'non_critical';\nconst confidence = Number.isFinite(Number(obj?.confidence)) ? Number(obj.confidence) : 0.6;\nconst reason = (obj?.reason || 'LLM classification fallback').toString().slice(0, 180);\nreturn [{ json: { ...base, severity, confidence, reason, classifiedBy: 'llm' } }];"
      }
    },
    {
      "id": "heuristic-classify",
      "name": "Heuristic classify severity",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        120
      ],
      "parameters": {
        "jsCode": "const base = $input.first().json;\nconst t = (base.title || '').toLowerCase();\nconst l = (base.level || '').toLowerCase();\nconst criticalSignals = ['fatal', 'outofmemory', 'oom', 'db down', 'payment', 'auth', 'timeout cascade', 'panic', 'crash loop'];\nconst hit = criticalSignals.find(s => t.includes(s));\nconst severity = (l === 'fatal' || hit) ? 'critical' : 'non_critical';\nconst reason = hit ? ('keyword: ' + hit) : ('level=' + l);\nconst confidence = severity === 'critical' ? 0.74 : 0.64;\nreturn [{ json: { ...base, severity, confidence, reason, classifiedBy: 'heuristic' } }];"
      }
    },
    {
      "id": "if-linear-team",
      "name": "If LINEAR_TEAM_ID set",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1540,
        0
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true
          },
          "conditions": [
            {
              "leftValue": "={{ $env.LINEAR_TEAM_ID || '' }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "if-critical",
      "name": "If critical",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1760,
        -120
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true
          },
          "conditions": [
            {
              "leftValue": "={{ $json.severity }}",
              "rightValue": "critical",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "linear-create-critical",
      "name": "Linear: Create critical issue",
      "type": "n8n-nodes-base.linear",
      "typeVersion": 1,
      "position": [
        1980,
        -220
      ],
      "parameters": {
        "resource": "issue",
        "operation": "create",
        "teamId": "={{ $env.LINEAR_TEAM_ID }}",
        "title": "=CRITICAL Sentry: {{ $json.title }}",
        "description": "=Severity: {{ $json.severity }} ({{ $json.classifiedBy }}, conf={{ $json.confidence }})\\nReason: {{ $json.reason }}\\nLevel: {{ $json.level }}\\nProject: {{ $json.project }}\\nURL: {{ $json.url }}\\nFingerprint: {{ $json.fingerprint }}\\n\\nPayload:\\n{{ $json.payloadSnippet }}",
        "additionalFields": {
          "priority": 1
        }
      },
      "credentials": {
        "linearApi": {
          "id": "SPM4RCmtiiJxQxSv",
          "name": "AIPipeline Linear"
        }
      },
      "retryOnFail": true,
      "maxTries": 4,
      "waitBetweenTries": 2000,
      "continueOnFail": true,
      "alwaysOutputData": true
    },
    {
      "id": "linear-create-normal",
      "name": "Linear: Create bug issue",
      "type": "n8n-nodes-base.linear",
      "typeVersion": 1,
      "position": [
        1980,
        -20
      ],
      "parameters": {
        "resource": "issue",
        "operation": "create",
        "teamId": "={{ $env.LINEAR_TEAM_ID }}",
        "title": "=Sentry: {{ $json.title }}",
        "description": "=Severity: {{ $json.severity }} ({{ $json.classifiedBy }}, conf={{ $json.confidence }})\\nReason: {{ $json.reason }}\\nLevel: {{ $json.level }}\\nProject: {{ $json.project }}\\nURL: {{ $json.url }}\\nFingerprint: {{ $json.fingerprint }}\\n\\nPayload:\\n{{ $json.payloadSnippet }}"
      },
      "credentials": {
        "linearApi": {
          "id": "SPM4RCmtiiJxQxSv",
          "name": "AIPipeline Linear"
        }
      },
      "retryOnFail": true,
      "maxTries": 4,
      "waitBetweenTries": 2000,
      "continueOnFail": true,
      "alwaysOutputData": true
    },
    {
      "id": "fmt-critical-msg",
      "name": "Format critical notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2200,
        -220
      ],
      "parameters": {
        "jsCode": "const src = $('If critical').first().json;\nconst err = $json.error || null;\nif (!err) {\n  return [{ json: { text: 'ðŸš¨ *CRITICAL* Sentry\\n' + src.title + '\\nLevel: ' + src.level + '\\nClassifier: ' + src.classifiedBy + ' (' + src.confidence + ')\\nReason: ' + src.reason + '\\nLinear: ' + ($json.identifier || $json.id || 'created') + '\\n' + (src.url || '') } }];\n}\nconst msg = String(err.message || err.description || JSON.stringify(err)).slice(0, 300);\nconst rateLimited = /429|rate\\s*limit|too many requests/i.test(msg);\nreturn [{ json: { text: 'ðŸš¨ *CRITICAL* Sentry\\n' + src.title + '\\nLevel: ' + src.level + '\\nClassifier: ' + src.classifiedBy + ' (' + src.confidence + ')\\nReason: ' + src.reason + '\\nâš ï¸ Linear create failed' + (rateLimited ? ' (rate-limited)' : '') + ': ' + msg + '\\n' + (src.url || ''), linearFailed: true, rateLimited, linearReason: msg } }];"
      }
    },
    {
      "id": "fmt-normal-msg",
      "name": "Format non-critical notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2200,
        -20
      ],
      "parameters": {
        "jsCode": "const src = $('If critical').first().json;\nconst err = $json.error || null;\nif (!err) {\n  return [{ json: { text: 'âš ï¸ *Sentry issue*\\n' + src.title + '\\nLevel: ' + src.level + '\\nClassifier: ' + src.classifiedBy + ' (' + src.confidence + ')\\nReason: ' + src.reason + '\\nLinear: ' + ($json.identifier || $json.id || 'created') + '\\n' + (src.url || '') } }];\n}\nconst msg = String(err.message || err.description || JSON.stringify(err)).slice(0, 300);\nconst rateLimited = /429|rate\\s*limit|too many requests/i.test(msg);\nreturn [{ json: { text: 'âš ï¸ *Sentry issue*\\n' + src.title + '\\nLevel: ' + src.level + '\\nClassifier: ' + src.classifiedBy + ' (' + src.confidence + ')\\nReason: ' + src.reason + '\\nâš ï¸ Linear create failed' + (rateLimited ? ' (rate-limited)' : '') + ': ' + msg + '\\n' + (src.url || ''), linearFailed: true, rateLimited, linearReason: msg } }];"
      }
    },
    {
      "id": "fmt-no-linear",
      "name": "Format no-linear notification",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1760,
        180
      ],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {
              "name": "text",
              "type": "string",
              "value": "=âš ï¸ Sentry alert classified as *{{ $json.severity }}* but LINEAR_TEAM_ID is not configured.\\nTitle: {{ $json.title }}\\nLevel: {{ $json.level }}\\nClassifier: {{ $json.classifiedBy }} ({{ $json.confidence }})\\nReason: {{ $json.reason }}\\n{{ $json.url || '' }}"
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "telegram-wf3",
      "name": "Telegram: notify",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2420,
        -20
      ],
      "parameters": {
        "operation": "sendMessage",
        "chatId": "1877269414",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "credentials": {
        "telegramApi": {
          "id": "CumMgGtm8MpeMfxm",
          "name": "AIPipeline Telegram"
        }
      },
      "retryOnFail": true,
      "maxTries": 4,
      "waitBetweenTries": 2000,
      "continueOnFail": true,
      "alwaysOutputData": true
    },
    {
      "id": "if-linear-message-failed",
      "name": "If Linear create failed",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2420,
        120
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true
          },
          "conditions": [
            {
              "leftValue": "={{ $json.linearFailed || false }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "dlq-park-wf3-linear",
      "name": "DLQ: park WF-3 Linear failure",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2640,
        120
      ],
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/wf-dlq-park",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { sourceWorkflow: 'WF-3', failureType: 'linear_create_failed', reason: $json.linearReason || 'unknown error', rateLimited: $json.rateLimited || false, replayTarget: (($env.WEBHOOK_URL || '').replace(/\\/$/, '') + '/webhook/wf3-sentry'), replayPayload: { title: $('If critical').first().json.title, level: $('If critical').first().json.level, culprit: $('If critical').first().json.culprit, project: $('If critical').first().json.project, url: $('If critical').first().json.url, fingerprint: $('If critical').first().json.fingerprint, event_id: $('If critical').first().json.eventId }, context: $('If critical').first().json } }}",
        "options": {}
      },
      "retryOnFail": true,
      "maxTries": 4,
      "waitBetweenTries": 2000,
      "continueOnFail": true,
      "alwaysOutputData": true
    },
    {
      "id": "assess-telegram-wf3",
      "name": "Assess Telegram notify delivery",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2640,
        -20
      ],
      "parameters": {
        "jsCode": "const err = $json.error || null;\nif (!err) return [{ json: { telegramFailed: false } }];\nconst msg = String(err.message || err.description || JSON.stringify(err)).slice(0, 360);\nconst rateLimited = /429|rate\\s*limit|too many requests/i.test(msg);\nreturn [{ json: { telegramFailed: true, rateLimited, reason: msg } }];"
      }
    },
    {
      "id": "if-telegram-wf3-failed",
      "name": "If Telegram notify failed",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2860,
        -20
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true
          },
          "conditions": [
            {
              "leftValue": "={{ $json.telegramFailed }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "dlq-park-wf3-telegram",
      "name": "DLQ: park WF-3 Telegram failure",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3080,
        -100
      ],
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/wf-dlq-park",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { sourceWorkflow: 'WF-3', failureType: 'telegram_send_failed', reason: $('Assess Telegram notify delivery').first().json.reason || 'unknown error', rateLimited: $('Assess Telegram notify delivery').first().json.rateLimited || false, context: $('If critical').first().json } }}",
        "options": {}
      },
      "retryOnFail": true,
      "maxTries": 4,
      "waitBetweenTries": 2000,
      "continueOnFail": true,
      "alwaysOutputData": true
    },
    {
      "id": "manual-wf3",
      "name": "When clicking 'Test workflow'",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        0,
        260
      ]
    },
    {
      "id": "placeholder-wf3",
      "name": "Placeholder",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        220,
        260
      ],
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\"info\":\"WF-3: Sentry webhook -> classify (OpenAI if configured) -> create Linear issue -> Telegram notify.\"}"
      }
    }
  ],
  "connections": {
    "Sentry Webhook": {
      "main": [
        [
          {
            "node": "Normalize Sentry event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Sentry event": {
      "main": [
        [
          {
            "node": "Deduplicate Sentry event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deduplicate Sentry event": {
      "main": [
        [
          {
            "node": "If duplicate event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If duplicate event": {
      "main": [
        [],
        [
          {
            "node": "If OPENAI_API_KEY set",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If OPENAI_API_KEY set": {
      "main": [
        [
          {
            "node": "OpenAI classify severity",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Heuristic classify severity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI classify severity": {
      "main": [
        [
          {
            "node": "If OpenAI request failed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If OpenAI request failed": {
      "main": [
        [
          {
            "node": "Heuristic classify severity",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Parse LLM result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse LLM result": {
      "main": [
        [
          {
            "node": "If LINEAR_TEAM_ID set",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Heuristic classify severity": {
      "main": [
        [
          {
            "node": "If LINEAR_TEAM_ID set",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If LINEAR_TEAM_ID set": {
      "main": [
        [
          {
            "node": "If critical",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format no-linear notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If critical": {
      "main": [
        [
          {
            "node": "Linear: Create critical issue",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Linear: Create bug issue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Linear: Create critical issue": {
      "main": [
        [
          {
            "node": "Format critical notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Linear: Create bug issue": {
      "main": [
        [
          {
            "node": "Format non-critical notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format critical notification": {
      "main": [
        [
          {
            "node": "If Linear create failed",
            "type": "main",
            "index": 0
          },
          {
            "node": "Telegram: notify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format non-critical notification": {
      "main": [
        [
          {
            "node": "If Linear create failed",
            "type": "main",
            "index": 0
          },
          {
            "node": "Telegram: notify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Linear create failed": {
      "main": [
        [
          {
            "node": "DLQ: park WF-3 Linear failure",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Format no-linear notification": {
      "main": [
        [
          {
            "node": "Telegram: notify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram: notify": {
      "main": [
        [
          {
            "node": "Assess Telegram notify delivery",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assess Telegram notify delivery": {
      "main": [
        [
          {
            "node": "If Telegram notify failed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Telegram notify failed": {
      "main": [
        [
          {
            "node": "DLQ: park WF-3 Telegram failure",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "When clicking 'Test workflow'": {
      "main": [
        [
          {
            "node": "Placeholder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  }
}
